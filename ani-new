#!/bin/sh

base_url=https://goload.pro
trap "exit 0" INT HUP
url=$(curl -s "$base_url" | sed -nE 's_.*<a href="/videos/([^"]*)">_\1_p' | fzf)
[ -z "$url" ] && exit 0 || printf "\033[1;31mSelected $url\n\033[1;36mFetching Episode embed link"
refr=$(curl -s "$base_url/videos/$url" | sed -nE 's/.*iframe src="(.*)" al.*/\1/p')
printf "\33[2K\r\033[1;34mEncrypting some shit"
resp="$(curl -s "https:$refr")"
id=$(printf "%s" "$refr" | sed -nE 's/.*id=(.*)&title.*/\1/p')
secret_key=$(printf "%s" "$resp" | sed -nE 's/.*class="container-(.*)">/\1/p' | tr -d "\n" | od -A n -t x1 | tr -d " |\n")
iv=$(printf "%s" "$resp" | sed -nE 's/.*class="wrapper container-(.*)">/\1/p' | tr -d "\n" | od -A n -t x1 | tr -d " |\n")
second_key=$(printf "%s" "$resp" | sed -nE 's/.*class=".*videocontent-(.*)">/\1/p' | tr -d "\n" | od -A n -t x1 | tr -d " |\n")
token=$(printf "%s" "$resp" | sed -nE 's/.*data-value="(.*)">.*/\1/p' | base64 -d | openssl enc -d -aes256 -K "$secret_key" -iv "$iv" | sed -nE 's/.*&(token.*)/\1/p')
ajax=$(printf '%s' "$id" |openssl enc -e -aes256 -K "$secret_key" -iv "$iv" | base64)
printf "\33[2K\r\033[1;35mDecrypting some shit"
data=$(curl -s -H "X-Requested-With:XMLHttpRequest" "${base_url}/encrypt-ajax.php?id=${ajax}&alias=${id}&${token}" | sed -e 's/{"data":"//' -e 's/"}/\n/' -e 's/\\//g')
video="$(printf "$data" | base64 -d | openssl enc -d -aes256 -K "$second_key" -iv "$iv" | sed -e 's/\].*/\]/' -e 's/\\//g' | grep -Eo 'https:\/\/[-a-zA-Z0-9@:%._\+~#=][a-zA-Z0-9][-a-zA-Z0-9@:%_\+.~#?&\/\/=]*' | head -4 | tail -1)"
printf "\33[2K\r\033[1;32mDownloading\033[0m %s\n" "$video"
case $video in
    *mp4*)
	    aria2c --summary-interval=0 -x 16 -s 16 --referer="$base_url" "$video" --dir=/storage/7689-5BBD -o "$url.mp4" --download-result=hide && termux-notification -t "Episode Downloaded" -c "$url" || exit 0;;
    *m3u*)
	    ffmpeg -loglevel error -stats -referer "$base_url" -i "$video" -map "p:4?" -c copy "/storage/7689-5BBD/$url.mp4" && termux-notification -t "Episode Downloaded" -c "$url" || exit 0;;
esac
